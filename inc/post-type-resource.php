<?php function filter_resource_archive_by_tag($query) { if (!is_admin() && $query->is_main_query() && is_post_type_archive('resource')) { if (!empty($_GET['tag'])) { $query->set('tag', sanitize_text_field($_GET['tag'])); } $query->set('posts_per_page', 12); $query->set('orderby', 'date'); $query->set('order', 'ASC'); } } add_action('pre_get_posts', 'filter_resource_archive_by_tag'); /** * 資料投稿タイプ（resource）に詳細情報のメタボックスを追加 */ function add_resource_meta_boxes() { add_meta_box( 'resource_meta', '資料の詳細情報', 'render_resource_meta_box', 'resource', 'normal', 'high' ); } add_action('add_meta_boxes', 'add_resource_meta_boxes'); /** * メタボックス描画処理（ページ数・更新日・内容・対象者・フォーム埋込） */ function render_resource_meta_box($post) { $page_count = get_post_meta($post->ID, 'page_count', true); $last_updated = get_post_meta($post->ID, 'last_updated', true); $summary = get_post_meta($post->ID, 'summary', true); $points = get_post_meta($post->ID, 'points', true); $audience = get_post_meta($post->ID, 'audience', true); $form_embed = get_post_meta($post->ID, 'form_embed', true); ?> <table class="form-table"> <tr> <th><label for="page_count">ページ数</label></th> <td><input type="text" name="page_count" id="page_count" class="regular-text" value="<?php echo esc_attr($page_count); ?>"></td> </tr> <tr> <th><label for="last_updated">資料の更新日（表示用）</label></th> <td><input type="text" name="last_updated" id="last_updated" class="regular-text" value="<?php echo esc_attr($last_updated); ?>"></td> </tr> <tr> <th><label for="summary">主な内容</label></th> <td><textarea name="summary" id="summary" class="large-text" rows="3"><?php echo esc_textarea($summary); ?></textarea></td> </tr> <tr> <th><label for="points">おすすめポイント</label></th> <td><textarea name="points" id="points" class="large-text" rows="3"><?php echo esc_textarea($points); ?></textarea></td> </tr> <tr> <th><label for="audience">対象者</label></th> <td><input type="text" name="audience" id="audience" class="regular-text" value="<?php echo esc_attr($audience); ?>"></td> </tr> <tr> <th><label for="form_embed">フォーム埋め込み（iframe）</label></th> <td><textarea name="form_embed" id="form_embed" class="large-text code" rows="5"><?php echo esc_textarea($form_embed); ?></textarea></td> </tr> </table> <?php } /** * メタボックスの保存処理 */ function save_resource_meta_box($post_id) { if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) return; $fields = ['page_count', 'summary', 'points', 'audience', 'form_embed', 'last_updated']; foreach ($fields as $field) { if (isset($_POST[$field])) { update_post_meta($post_id, $field, $_POST[$field]); } } } add_action('save_post_resource', 'save_resource_meta_box'); /** * 固定ページにカスタムCSSを出力（page_custom_cssメタフィールド） */ function rcp2025_add_custom_page_css() { if (is_page()) { global $post; $css = get_post_meta($post->ID, 'page_custom_css', true); if (!empty($css)) { echo '<style>' . $css . '</style>'; } } } add_action('wp_head', 'rcp2025_add_custom_page_css');